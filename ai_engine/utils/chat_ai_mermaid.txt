
flowchart TD
    %% Style definitions
    classDef startEnd fill:#4CAF50,stroke:#333,color:#fff,stroke-width:2px
    classDef input fill:#2196F3,stroke:#333,color:#fff,stroke-width:2px
    classDef process fill:#FF9800,stroke:#333,color:#fff,stroke-width:2px
    classDef decision fill:#f44336,stroke:#333,color:#fff,stroke-width:2px
    classDef database fill:#9C27B0,stroke:#333,color:#fff,stroke-width:2px
    classDef output fill:#00BCD4,stroke:#333,color:#fff,stroke-width:2px
    classDef aimodel fill:#E91E63,stroke:#333,color:#fff,stroke-width:2px

    %% Main Flow
    START([ğŸš€ Báº®T Äáº¦U<br>User gá»­i cÃ¢u há»i]):::startEnd
    
    INPUT[ğŸ“¥ NHáº¬N CÃ‚U Há»I<br>RAGEngine.generate_answer]:::input
    
    SESSION[(ğŸ’¾ QUáº¢N LÃ SESSION<br>ChatSession.load/create)]:::database
    
    CLASSIFY[âš™ï¸ PHÃ‚N LOáº I Ã Äá»ŠNH<br>classify_intent]:::process
    
    INTENT{{"ğŸ”€ Loáº¡i cÃ¢u há»i?"}}:::decision
    
    %% Branch: Greeting
    GREETING[ğŸ‘‹ Tráº£ lá»i chÃ o<br>answer_greeting]:::output
    
    %% Branch: Follow-up
    FOLLOWUP[ğŸ”„ DÃ¹ng káº¿t quáº£ cÅ©<br>answer_followup]:::process
    FOLLOWUP_GEMINI[ğŸ¤– Gá»i Gemini AI]:::aimodel
    
    %% Branch: New Query
    LIB_CHECK{{"ğŸ“š Library Info?"}}:::decision
    
    LIB_INFO[â„¹ï¸ ThÃ´ng tin thÆ° viá»‡n<br>LIBRARY_INFO]:::output
    
    SEARCH[ğŸ” TÃŒM KIáº¾M SÃCH<br>_perform_book_search]:::process
    
    VECTORDB[(ğŸ—„ï¸ VECTOR DATABASE<br>SearchEngine.search<br>ChromaDB)]:::database
    
    RESULT_CHECK{{"ğŸ“Š CÃ³ káº¿t quáº£?"}}:::decision
    
    FALLBACK[ğŸ¤– GEMINI FALLBACK<br>_gemini_fallback]:::aimodel
    
    BUILD_CTX[ğŸ“ XÃ‚Y Dá»°NG CONTEXT<br>Káº¿t há»£p results + history]:::process
    
    GEMINI[ğŸ§  GEMINI AI MODEL<br>_call_gemini<br>ModelManager]:::aimodel
    
    SAVE_SESSION[(ğŸ’¾ LÆ¯U SESSION<br>ChatSession.save)]:::database
    
    RESPONSE[ğŸ“¤ TRáº¢ Lá»œI USER<br>Response]:::output
    
    ENDNODE([âœ… Káº¾T THÃšC]):::startEnd

    %% Connections - Main Flow
    START --> INPUT
    INPUT --> SESSION
    SESSION --> CLASSIFY
    CLASSIFY --> INTENT
    
    %% Intent branches
    INTENT -->|"ChÃ o há»i"| GREETING
    INTENT -->|"Follow-up"| FOLLOWUP
    INTENT -->|"CÃ¢u há»i má»›i"| LIB_CHECK
    
    %% Greeting path
    GREETING --> RESPONSE
    
    %% Follow-up path
    FOLLOWUP --> FOLLOWUP_GEMINI
    FOLLOWUP_GEMINI --> SAVE_SESSION
    
    %% Library info check
    LIB_CHECK -->|"Yes"| LIB_INFO
    LIB_CHECK -->|"No"| SEARCH
    
    LIB_INFO --> RESPONSE
    
    %% Search path
    SEARCH --> VECTORDB
    VECTORDB --> RESULT_CHECK
    
    %% Result check branches
    RESULT_CHECK -->|"No"| FALLBACK
    RESULT_CHECK -->|"Yes"| BUILD_CTX
    
    FALLBACK --> SAVE_SESSION
    
    BUILD_CTX --> GEMINI
    GEMINI --> SAVE_SESSION
    
    SAVE_SESSION --> RESPONSE
    RESPONSE --> ENDNODE
